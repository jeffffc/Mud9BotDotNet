name: Mud9Bot CI/CD Console

on:
  push:
    branches: [ main ]
  repository_dispatch:
    types: [trigger_build_bot, trigger_build_web, trigger_deploy_bot, trigger_deploy_web]

jobs:
  # ---------------------------------------------------------
  # 1. åµæ¸¬è®Šæ›´ä¸¦ç™¼é€é€šçŸ¥
  # ---------------------------------------------------------
  notify-push:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    outputs:
      bot: ${{ steps.filter.outputs.bot }}
      web: ${{ steps.filter.outputs.web }}
    steps:
      - uses: actions/checkout@v4
      
      # ğŸš€ åµæ¸¬æª”æ¡ˆè·¯å¾‘è®Šæ›´
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            bot:
              - 'Mud9Bot/**'
              - 'Mud9Bot.Data/**'
            web:
              - 'Mud9Bot.Web/**'
              - 'Mud9Bot.Data/**'

      # ğŸ¤– å¦‚æœæœ‰ Bot è®Šæ›´ï¼Œç™¼é€ Bot é€šçŸ¥
      - name: Send Bot Notification
        if: steps.filter.outputs.bot == 'true'
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_LOG_GROUP_ID }}" \
          -d "parse_mode=HTML" \
          -d "text=ğŸ¤– <b>[Bot] New Changes Detected</b>%0AAuthor: <b>${{ github.actor }}</b>%0ASHA: <code>${{ github.sha }}</code>%0AMsg: <code>${{ github.event.head_commit.message }}</code>" \
          -d "reply_markup={\"inline_keyboard\":[[{\"text\":\"ğŸ”¨ Build Bot\",\"callback_data\":\"GH_BUILD_BOT+${{ github.sha }}\"},{\"text\":\"âŒ Cancel\",\"callback_data\":\"GH_CANCEL+${{ github.sha }}\"}]]}"

      # ğŸŒ å¦‚æœæœ‰ Web è®Šæ›´ï¼Œç™¼é€ Web é€šçŸ¥
      - name: Send Web Notification
        if: steps.filter.outputs.web == 'true'
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_LOG_GROUP_ID }}" \
          -d "parse_mode=HTML" \
          -d "text=ğŸŒ <b>[Web] New Changes Detected</b>%0AAuthor: <b>${{ github.actor }}</b>%0ASHA: <code>${{ github.sha }}</code>%0AMsg: <code>${{ github.event.head_commit.message }}</code>" \
          -d "reply_markup={\"inline_keyboard\":[[{\"text\":\"ğŸ”¨ Build Web\",\"callback_data\":\"GH_BUILD_WEB+${{ github.sha }}\"},{\"text\":\"âŒ Cancel\",\"callback_data\":\"GH_CANCEL+${{ github.sha }}\"}]]}"

  # ---------------------------------------------------------
  # 2. Bot ç·¨è­¯éšæ®µ (ç”± GH_BUILD_BOT æŒ‰éˆ•è§¸ç™¼)
  # ---------------------------------------------------------
  build-bot:
    if: github.event.action == 'trigger_build_bot'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.sha }}
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      - name: Build Bot
        run: dotnet publish Mud9Bot/Mud9Bot.csproj -c Release -o ./publish_bot
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: bot-pkg-${{ github.event.client_payload.sha }}
          path: publish_bot/
      - name: Notify Bot Build Success
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_LOG_GROUP_ID }}" \
          -d "parse_mode=HTML" \
          -d "text=âœ… <b>Bot Build Success!</b>%0ASHA: <code>${{ github.event.client_payload.sha }}</code>%0A%0Aå·²å®Œæˆç·¨è­¯ï¼Œæº–å‚™å¥½éƒ¨ç½² Bot å—ï¼Ÿ" \
          -d "reply_markup={\"inline_keyboard\":[[{\"text\":\"ğŸš€ Deploy Bot\",\"callback_data\":\"GH_DEPLOY_BOT+${{ github.event.client_payload.sha }}\"},{\"text\":\"âŒ Cancel\",\"callback_data\":\"GH_CANCEL+${{ github.event.client_payload.sha }}\"}]]}"

  # ---------------------------------------------------------
  # 3. Web ç·¨è­¯éšæ®µ (ç”± GH_BUILD_WEB æŒ‰éˆ•è§¸ç™¼)
  # ---------------------------------------------------------
  build-web:
    if: github.event.action == 'trigger_build_web'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.sha }}
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      - name: Build Web
        run: dotnet publish Mud9Bot.Web/Mud9Bot.Web.csproj -c Release -o ./publish_web
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-pkg-${{ github.event.client_payload.sha }}
          path: publish_web/
      - name: Notify Web Build Success
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_LOG_GROUP_ID }}" \
          -d "parse_mode=HTML" \
          -d "text=âœ… <b>Web Build Success!</b>%0ASHA: <code>${{ github.event.client_payload.sha }}</code>%0A%0Aå·²å®Œæˆç·¨è­¯ï¼Œæº–å‚™å¥½éƒ¨ç½² Web å—ï¼Ÿ" \
          -d "reply_markup={\"inline_keyboard\":[[{\"text\":\"ğŸš€ Deploy Web\",\"callback_data\":\"GH_DEPLOY_WEB+${{ github.event.client_payload.sha }}\"},{\"text\":\"âŒ Cancel\",\"callback_data\":\"GH_CANCEL+${{ github.event.client_payload.sha }}\"}]]}"

  # ---------------------------------------------------------
  # 4. Bot éƒ¨ç½²éšæ®µ
  # ---------------------------------------------------------
  deploy-bot:
    if: github.event.action == 'trigger_deploy_bot'
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: bot-pkg-${{ github.event.client_payload.sha }}
          path: publish_bot/
      - name: Deploy Bot to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "publish_bot/"
          target: "${{ secrets.BOT_DEPLOY_PATH }}/releases/${{ github.event.client_payload.sha }}"
          strip_components: 1
      - name: Swap Bot & Restart
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            B_PATH="${{ secrets.BOT_DEPLOY_PATH }}"
            SHA="${{ github.event.client_payload.sha }}"
            ln -sfn $B_PATH/releases/$SHA $B_PATH/current
            cd $B_PATH/releases && ls -t | tail -n +6 | xargs -r rm -rf
            sudo systemctl restart ${{ secrets.BOT_SERVICE_NAME }}
      - name: Final Notification Bot
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_LOG_GROUP_ID }}" \
          -d "text=ğŸ‰ [Bot] Deployment Complete! Version: ${{ github.event.client_payload.sha }}"

  # ---------------------------------------------------------
  # 5. Web éƒ¨ç½²éšæ®µ
  # ---------------------------------------------------------
  deploy-web:
    if: github.event.action == 'trigger_deploy_web'
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: web-pkg-${{ github.event.client_payload.sha }}
          path: publish_web/
      - name: Deploy Web to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "publish_web/"
          target: "${{ secrets.WEB_DEPLOY_PATH }}/releases/${{ github.event.client_payload.sha }}"
          strip_components: 1
      - name: Swap Web & Restart
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            W_PATH="${{ secrets.WEB_DEPLOY_PATH }}"
            SHA="${{ github.event.client_payload.sha }}"
            ln -sfn $W_PATH/releases/$SHA $W_PATH/current
            cd $W_PATH/releases && ls -t | tail -n +6 | xargs -r rm -rf
            sudo systemctl restart ${{ secrets.WEB_SERVICE_NAME }}
      - name: Final Notification Web
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_LOG_GROUP_ID }}" \
          -d "text=ğŸ‰ [Web] Deployment Complete! Version: ${{ github.event.client_payload.sha }}"